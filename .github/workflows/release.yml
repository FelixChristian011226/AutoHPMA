# .github/workflows/release.yml

name: Build, Package, and Release WPF App

on:
  # 1. 当一个 'v' 开头的标签被推送到仓库时 (例如 v1.0.0, v1.2.3)
  push:
    tags:
      - 'v*.*.*'
  # 2. 允许在 GitHub Actions 页面手动触发，并要求输入版本号
  workflow_dispatch:
    inputs:
      version:
        description: '请输入要发布的版本号 (例如: 1.2.3)'
        required: true
        type: string

jobs:
  # ===============================================================
  # Job 1: 构建 WPF 应用 (Publish)
  # ===============================================================
  build_app:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore, Build, and Publish
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --no-build -o ./publish_output
      - name: Upload publish output
        uses: actions/upload-artifact@v4
        with:
          name: publish-output
          path: ./publish_output
          retention-days: 1

  # ===============================================================
  # Job 2: 构建安装包 (Installer Build)
  # ===============================================================
  build_installer:
    needs: build_app
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download publish output
        uses: actions/download-artifact@v4
        with:
          name: publish-output
          path: ./publish_output
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2
      - name: Install 7-Zip
        run: choco install 7zip.install --params "'/S'"
      - name: Add 7-Zip to PATH
        run: echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh
      - name: Build Installer
        shell: cmd
        run: |
          chcp 936
          7z a ./publish.7z ./publish_output/*
          move ./publish.7z ./Build/MicaSetup/Resources/Setups/publish.7z
          cd ./Build
          cmd /c build_autohpma.bat
      - name: Upload installer asset
        uses: actions/upload-artifact@v4
        with:
          name: installer-asset
          path: Build/AutoHPMA-Setup.exe
          retention-days: 1

# ===============================================================
  # Job 3: 构建更新包 (Updater Build)
  # ===============================================================
  build_updater:
    needs: build_app
    runs-on: windows-latest
    outputs:
      version: ${{ steps.determine_version.outputs.version_number }} # 输出版本号给其他 job 使用
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download publish output
        uses: actions/download-artifact@v4
        with:
          name: publish-output
          path: ./publish_output

      - name: Determine Version Number
        id: determine_version
        shell: bash
        run: |
          # 检查是 push 触发还是 workflow_dispatch 触发
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # 从 git tag (例如 "v1.2.3") 中移除 "v"
            # 正确的 Bash 语法在这里
            GIT_TAG="${{ github.ref_name }}"
            VERSION_NUMBER="${GIT_TAG#v}"
          else
            # 使用手动输入的版本号
            VERSION_NUMBER="${{ inputs.version }}"
          fi
          
          # 将版本号设置为环境变量，供后续步骤使用
          echo "APP_VERSION=${VERSION_NUMBER}" >> $GITHUB_ENV
          
          # 将版本号设置为此步骤的输出，供其他 job 使用
          echo "version_number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          
          echo "Determined version: ${VERSION_NUMBER}"

      - name: Build Updater
        shell: cmd
        run: |
          rem 切换到中文代码页，防止 bat 脚本乱码
          chcp 936
          
          rem 复制应用文件
          xcopy /E /I /Y publish_output Update\publish
          
          rem 运行打包脚本，脚本会自动读取环境变量 %APP_VERSION%
          cd ./Update
          cmd /c "1-updater.bat"
          cmd /c "2-installer.bat"

      - name: Upload updater asset
        uses: actions/upload-artifact@v4
        with:
          name: updater-asset
          path: Update/AutoHPMA.Install.exe
          retention-days: 1
